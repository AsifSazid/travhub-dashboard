# ЁЯУД **generate_meta_data.php - Documentation**

## ЁЯОп **Purpose**
ржПржЯрж┐ **Meta Data** рждрзИрж░рж┐ ржХрж░рж╛рж░ ржЬржирзНржп ржПржХржЯрж┐ ржлрж╛ржВрж╢ржиред Meta Data ржорж╛ржирзЗ рж╣рж▓рзЛ - ржХрзЗ ржХржЦржи ржбрж╛ржЯрж╛ рждрзИрж░рж┐ ржХрж░рж▓рзЛ ржПржмржВ ржХрзЗ ржХржЦржи ржЖржкржбрзЗржЯ ржХрж░рж▓рзЛ рждрж╛рж░ рж╕ржорзНржкрзВрж░рзНржг рж╣рж┐рж╕рзНржЯрзНрж░рж┐ред

## ЁЯУБ **How to Use**

### **Step 1: Require ржХрж░рзБржи**
ржЖржкржирж┐ ржпрзЗржХрзЛржирзЛ API ржлрзЛрж▓рзНржбрж╛рж░рзЗ ржЖржЫрзЗржи (ржпрзЗржоржи: `api/clients/`, `api/leads/`, `api/works/`, `api/vendor/`) - рж╕рзЗржЦрж╛ржи ржерзЗржХрзЗ ржлрж╛ржЗрж▓ржЯрж┐ require ржХрж░рзБржи:

```php
require_once '../../server/generate_meta_data.php';
```
ржЕржержмрж╛
```php
require '../../server/generate_meta_data.php';
```

### **Step 2: ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи**

#### **Case A: ржирждрзБржи ржбрж╛ржЯрж╛ рждрзИрж░рж┐ ржХрж░рж╛рж░ рж╕ржорзЯ (CREATE)**
```php
$metaDataJson = buildMetaData(
    null,
    $_SESSION['user_name'] ?? 'system'
);
```

**ржмрзНржпрж╛ржЦрзНржпрж╛:**
- ржкрзНрж░ржержо ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ `null` ржжрж┐рждрзЗ рж╣ржмрзЗ (ржХрж╛рж░ржг ржирждрзБржи ржбрж╛ржЯрж╛)
- ржжрзНржмрж┐рждрзАрзЯ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ user ржирж╛ржо (рж╕рзЗрж╢ржи ржерзЗржХрзЗ ржЕржержмрж╛ ржбрж┐ржлрж▓рзНржЯ 'system')

#### **Case B: existing ржбрж╛ржЯрж╛ ржЖржкржбрзЗржЯ ржХрж░рж╛рж░ рж╕ржорзЯ (UPDATE)**
```php
// 1. ржкрзНрж░ржержорзЗ Database ржерзЗржХрзЗ ржкрзБрж░рж╛ржирзЛ meta_data ржкрзЬрзБржи
$stmt = $pdo->prepare("SELECT meta_data FROM your_table WHERE id = :id");
$stmt->execute(['id' => $id]);
$row = $stmt->fetch(PDO::FETCH_ASSOC);

// 2. ржирждрзБржи meta_data рждрзИрж░рж┐ ржХрж░рзБржи
$metaDataJson = buildMetaData(
    $row['meta_data'],
    $_SESSION['user_name'] ?? 'demo_name'
);
```

**ржмрзНржпрж╛ржЦрзНржпрж╛:**
- ржкрзНрж░ржержо ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ Database ржерзЗржХрзЗ ржкрзЬрж╛ ржкрзБрж░рж╛ржирзЛ JSON
- ржжрзНржмрж┐рждрзАрзЯ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ ржпрж┐ржирж┐ ржЖржкржбрзЗржЯ ржХрж░ржЫрзЗржи рждрж╛рж░ ржирж╛ржо

## ЁЯТ╛ **Database ржП Save ржХрж░рж╛рж░ ржирж┐рзЯржо**

### **ржирждрзБржи ржбрж╛ржЯрж╛ INSERT:**
```php
$stmt = $pdo->prepare("
    INSERT INTO your_table (name, email, meta_data) 
    VALUES (:name, :email, :meta_data)
");

$stmt->execute([
    'name' => $name,
    'email' => $email,
    'meta_data' => $metaDataJson  // ржПржЦрж╛ржирзЗ meta_data pass ржХрж░рзБржи
]);
```

### **Existing ржбрж╛ржЯрж╛ UPDATE:**
```php
$stmt = $pdo->prepare("
    UPDATE your_table 
    SET name = :name, meta_data = :meta_data 
    WHERE id = :id
");

$stmt->execute([
    'name' => $newName,
    'meta_data' => $metaDataJson,  // ржирждрзБржи meta_data
    'id' => $recordId
]);
```

## ЁЯУК **Meta Data ржПрж░ Structure**
ржлрж╛ржВрж╢ржиржЯрж┐ ржирж┐ржЪрзЗрж░ ржлрж░ржорзНржпрж╛ржЯрзЗ JSON рж░рж┐ржЯрж╛рж░рзНржи ржХрж░рзЗ:

```json
{
    "created_by_date": {
        "user": "demo_name",
        "date": "03-01-2026 16:40"
    },
    "updated_by_date": [
        {"user": "demo_name", "date": "03-01-2026 16:40"},
        {"user": "admin", "date": "04-01-2026 11:05"}
    ]
}
```

- **created_by_date**: ржкрзНрж░ржержо ржХрзЗ рждрзИрж░рж┐ ржХрж░рзЗржЫрж┐рж▓рзЛ
- **updated_by_date**: рж▓рж┐рж╕рзНржЯ ржЖржХрж╛рж░рзЗ рж╕ржм ржЖржкржбрзЗржЯ рж╣рж┐рж╕рзНржЯрзНрж░рж┐

## тЪая╕П **ржоржирзЗ рж░рж╛ржЦрж╛рж░ ржмрж┐рж╖рзЯ**
1. **Path рж╕ржарж┐ржХ ржЖржЫрзЗ ржХрж┐ржирж╛** check ржХрж░рзБржи: рж╕ржм API ржерзЗржХрзЗ `../../server/`
2. **Session** ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ `session_start()` call ржХрж░рзБржи
3. Database column ржПрж░ type **JSON** ржмрж╛ **TEXT** рж░рж╛ржЦрзБржи

## тЬЕ **рж╕ржлрж▓ ржмрзНржпржмрж╣рж╛рж░рзЗрж░ ржЙржжрж╛рж╣рж░ржг**

```php
// File: api/clients/store.php
<?php
session_start();
require_once '../../server/generate_meta_data.php';

if ($isNewClient) {
    // CREATE
    $meta = buildMetaData(null, $_SESSION['user_name']);
    // ... INSERT to database
} else {
    // UPDATE
    $oldMeta = $client['meta_data'];
    $newMeta = buildMetaData($oldMeta, $_SESSION['user_name']);
    // ... UPDATE database
}
```

**рж╕рж╣ржЬ ржирж┐рзЯржо:** ржирждрзБржи ржмрж╛ржирж╛рждрзЗ `null`, ржЖржкржбрзЗржЯ ржХрж░рждрзЗ `ржкрзБрж░рж╛ржирзЛ JSON` ржжрж┐ржиред тЬЕ